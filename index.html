<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Le Mie Finanze</title>
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f7;
            --bg-tertiary: #e8e8ed;
            --text-primary: #1d1d1f;
            --text-secondary: #86868b;
            --accent-blue: #007aff;
            --accent-blue-hover: #0051d5;
            --accent-green: #34c759;
            --accent-red: #ff3b30;
            --accent-orange: #ff9500;
            --card-bg: #ffffff;
            --border-color: #d2d2d7;
            --shadow: rgba(0, 0, 0, 0.1);
            --shadow-strong: rgba(0, 0, 0, 0.15);
        }

        [data-theme="dark"] {
            --bg-primary: #000000;
            --bg-secondary: #1c1c1e;
            --bg-tertiary: #2c2c2e;
            --text-primary: #f5f5f7;
            --text-secondary: #98989d;
            --accent-blue: #0a84ff;
            --accent-blue-hover: #409cff;
            --accent-green: #32d74b;
            --accent-red: #ff453a;
            --accent-orange: #ff9f0a;
            --card-bg: #1c1c1e;
            --border-color: #38383a;
            --shadow: rgba(0, 0, 0, 0.3);
            --shadow-strong: rgba(0, 0, 0, 0.5);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-secondary);
            min-height: 100vh;
            padding: 20px;
            transition: background 0.3s ease;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* HEADER */
        header {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px var(--shadow);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        h1 {
            color: var(--text-primary);
            font-size: 34px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 15px;
            font-weight: 400;
        }

        /* THEME TOGGLE */
        .theme-toggle {
            position: relative;
            width: 60px;
            height: 32px;
            background: var(--bg-tertiary);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
        }

        .theme-toggle-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background: var(--card-bg);
            border-radius: 50%;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px var(--shadow);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        [data-theme="dark"] .theme-toggle-slider {
            left: 31px;
        }

        .total-balance {
            background: linear-gradient(135deg, var(--accent-blue) 0%, #5856d6 100%);
            padding: 20px 24px;
            border-radius: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.2);
        }

        .total-label {
            color: rgba(255, 255, 255, 0.9);
            font-size: 15px;
            font-weight: 500;
        }

        .total-value {
            color: white;
            font-size: 28px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        /* MONTH SELECTOR */
        .month-selector {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .month-selector button {
            background: var(--card-bg);
            color: var(--accent-blue);
            border: 1px solid var(--border-color);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            font-weight: 600;
        }

        .month-selector button:hover {
            background: var(--bg-tertiary);
            transform: scale(1.05);
        }

        .current-month {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            min-width: 200px;
            text-align: center;
            letter-spacing: -0.3px;
        }

        /* TABS */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            background: var(--card-bg);
            padding: 6px;
            border-radius: 14px;
            box-shadow: 0 2px 10px var(--shadow);
            border: 1px solid var(--border-color);
        }

        .tab {
            flex: 1;
            background: transparent;
            border: none;
            padding: 12px 16px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.2s ease;
        }

        .tab.active {
            background: var(--accent-blue);
            color: white;
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3);
        }

        .tab:hover:not(.active) {
            color: var(--accent-blue);
        }

        /* CONTENT */
        .content {
            background: var(--card-bg);
            padding: 24px;
            border-radius: 20px;
            box-shadow: 0 2px 10px var(--shadow);
            border: 1px solid var(--border-color);
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        /* STATS GRID */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-bottom: 30px;
        }

        .stat-card {
            padding: 24px;
            border-radius: 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
        }

        .stat-card.positive {
            background: linear-gradient(135deg, rgba(52, 199, 89, 0.1) 0%, rgba(52, 199, 89, 0.05) 100%);
            border-color: rgba(52, 199, 89, 0.2);
        }

        .stat-card.negative {
            background: linear-gradient(135deg, rgba(255, 59, 48, 0.1) 0%, rgba(255, 59, 48, 0.05) 100%);
            border-color: rgba(255, 59, 48, 0.2);
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.5px;
        }

        /* CATEGORY DRAWERS */
        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 12px;
            margin-top: 20px;
        }

        .category-drawer {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px var(--shadow);
            position: relative;
            border: 1px solid var(--border-color);
        }

        .category-drawer:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 8px 20px var(--shadow-strong);
        }

        .category-drawer.income {
            background: linear-gradient(135deg, rgba(52, 199, 89, 0.15) 0%, rgba(52, 199, 89, 0.05) 100%);
            border-color: rgba(52, 199, 89, 0.3);
        }

        .category-drawer.expense {
            background: linear-gradient(135deg, rgba(255, 59, 48, 0.15) 0%, rgba(255, 59, 48, 0.05) 100%);
            border-color: rgba(255, 59, 48, 0.3);
        }

        .category-icon {
            font-size: 36px;
            margin-bottom: 12px;
            filter: drop-shadow(0 2px 4px var(--shadow));
        }

        .category-name {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 6px;
            letter-spacing: -0.2px;
        }

        .category-total {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .delete-category, .edit-category {
            position: absolute;
            top: 10px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 14px;
            cursor: pointer;
            font-size: 14px;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
        }

        .delete-category {
            right: 10px;
        }

        .edit-category {
            right: 42px;
        }

        .category-drawer:hover .delete-category,
        .category-drawer:hover .edit-category {
            display: flex;
        }

        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px var(--shadow-strong);
            border: 1px solid var(--border-color);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-title {
            font-size: 22px;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.3px;
        }

        .close-modal {
            background: var(--bg-tertiary);
            border: none;
            font-size: 24px;
            color: var(--text-secondary);
            cursor: pointer;
            width: 32px;
            height: 32px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            border: 1px solid var(--border-color);
        }

        .close-modal:hover {
            background: var(--border-color);
            color: var(--text-primary);
        }

        /* FORM */
        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-primary);
            font-weight: 500;
            font-size: 15px;
        }

        input, select {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            font-size: 15px;
            transition: all 0.2s;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1);
        }

        /* BUTTONS */
        .btn {
            background: var(--accent-blue);
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
            width: 100%;
        }

        .btn:hover {
            background: var(--accent-blue-hover);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 122, 255, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-success {
            background: var(--accent-green);
            box-shadow: 0 4px 12px rgba(52, 199, 89, 0.3);
        }

        .btn-success:hover {
            background: #2ab04b;
        }

        .btn-danger {
            background: var(--accent-red);
            box-shadow: 0 4px 12px rgba(255, 59, 48, 0.3);
        }

        .btn-danger:hover {
            background: #e8271c;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
        }

        .btn-icon {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 18px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            border: 1px solid var(--border-color);
        }

        .btn-icon:hover {
            background: var(--accent-blue);
            color: white;
            transform: scale(1.1);
        }

        .btn-icon.btn-danger {
            background: var(--accent-red);
            color: white;
        }

        .btn-icon.btn-danger:hover {
            background: #e8271c;
        }

        /* CALCULATOR */
        .calculator-display {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            font-size: 36px;
            font-weight: 700;
            text-align: right;
            color: var(--text-primary);
            margin-bottom: 16px;
            min-height: 70px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            letter-spacing: -1px;
        }

        .calculator-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .calc-btn {
            padding: 18px;
            font-size: 20px;
            font-weight: 600;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .calc-btn:hover {
            background: var(--bg-tertiary);
            transform: scale(1.05);
        }

        .calc-btn:active {
            transform: scale(0.95);
        }

        .calc-btn-operator {
            background: var(--accent-blue);
            color: white;
            border-color: var(--accent-blue);
        }

        .calc-btn-clear {
            background: var(--accent-orange);
            color: white;
            border-color: var(--accent-orange);
        }

        .calc-btn-equals {
            background: var(--accent-green);
            color: white;
            border-color: var(--accent-green);
        }

        /* EMOJI PICKER */
        .emoji-picker {
            background: var(--bg-secondary);
            padding: 16px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
        }

        .emoji-option {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-size: 24px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .emoji-option:hover {
            border-color: var(--accent-blue);
            transform: scale(1.1);
        }

        .emoji-option.selected {
            border-color: var(--accent-blue);
            background: rgba(0, 122, 255, 0.1);
        }

        /* TRANSACTIONS */
        .transaction-list {
            margin-top: 24px;
        }

        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.2s;
        }

        .transaction-item:last-child {
            border-bottom: none;
        }

        .transaction-item:hover {
            background-color: var(--bg-secondary);
        }

        .transaction-info {
            flex: 1;
        }

        .transaction-category {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
            font-size: 15px;
        }

        .transaction-details {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .transaction-amount {
            font-size: 18px;
            font-weight: 700;
            margin-right: 12px;
            letter-spacing: -0.3px;
        }

        .transaction-amount.income {
            color: var(--accent-green);
        }

        .transaction-amount.expense {
            color: var(--accent-red);
        }

        /* ACCOUNTS */
        .account-list {
            display: grid;
            gap: 12px;
            margin-top: 20px;
        }

        .account-card {
            padding: 20px;
            border-radius: 16px;
            background: var(--bg-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid var(--border-color);
            transition: all 0.2s;
        }

        .account-card:hover {
            box-shadow: 0 4px 12px var(--shadow);
        }

        .account-info h3 {
            color: var(--text-primary);
            margin-bottom: 8px;
            font-size: 17px;
            font-weight: 600;
        }

        .account-info small {
            font-size: 13px;
            display: block;
            margin-top: 4px;
        }

        .account-balance {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.5px;
        }

        .add-category-btn {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 20px;
            border-radius: 16px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s;
            box-shadow: 0 2px 6px var(--shadow);
        }

        .add-category-btn:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px var(--shadow-strong);
            background: var(--accent-blue);
            color: white;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* CHARTS */
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            margin-top: 30px;
        }

        .chart-card {
            padding: 24px;
            border-radius: 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
        }

        .chart-title {
            font-size: 17px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 16px;
            text-align: center;
        }

        canvas {
            max-width: 100%;
            height: auto !important;
        }

        @media (max-width: 768px) {
            .category-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .charts-container {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 28px;
            }

            .tabs {
                overflow-x: auto;
                flex-wrap: nowrap;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-top">
                <div>
                    <h1>üí∞ Le Mie Finanze</h1>
                    <p class="subtitle">Gestisci le tue entrate e uscite in modo semplice</p>
                </div>
                <div class="theme-toggle" onclick="toggleTheme()">
                    <div class="theme-toggle-slider" id="themeToggleSlider">
                        <span id="themeIcon">‚òÄÔ∏è</span>
                    </div>
                </div>
            </div>
            <div class="total-balance" id="totalBalance">
                <span class="total-label">Totale disponibile:</span>
                <span class="total-value">‚Ç¨0,00</span>
            </div>
        </header>

        <div class="month-selector">
            <button onclick="changeMonth(-1)">‚Üê</button>
            <div class="current-month" id="currentMonthDisplay"></div>
            <button onclick="changeMonth(1)">‚Üí</button>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('income')">‚ûï Entrate</button>
            <button class="tab" onclick="switchTab('expenses')">‚ûñ Uscite</button>
            <button class="tab" onclick="switchTab('balance')">üí∞ Saldo</button>
            <button class="tab" onclick="switchTab('accounts')">üè¶ Conti</button>
            <button class="tab" onclick="switchTab('categories')">‚öôÔ∏è Categorie</button>
        </div>

        <div class="content">
            <!-- ENTRATE -->
            <div id="income" class="section active">
                <h2 style="margin-bottom: 20px; color: #333;">Registra Entrata</h2>
                <div class="category-grid" id="incomeCategories"></div>
            </div>

            <!-- USCITE -->
            <div id="expenses" class="section">
                <h2 style="margin-bottom: 20px; color: #333;">Registra Uscita</h2>
                <div class="category-grid" id="expenseCategories"></div>
            </div>

            <!-- SALDO -->
            <div id="balance" class="section">
                <h2 style="margin-bottom: 20px; color: #333;">Riepilogo Mensile</h2>
                
                <div class="stats-grid">
                    <div class="stat-card positive">
                        <div class="stat-label">Entrate del mese</div>
                        <div class="stat-value" id="totalIncome">‚Ç¨0,00</div>
                    </div>
                    <div class="stat-card negative">
                        <div class="stat-label">Uscite del mese</div>
                        <div class="stat-value" id="totalExpenses">‚Ç¨0,00</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Saldo del mese</div>
                        <div class="stat-value" id="balanceValue">‚Ç¨0,00</div>
                    </div>
                </div>

                <div class="charts-container">
                    <div class="chart-card">
                        <h3 class="chart-title">Entrate per Categoria</h3>
                        <div class="chart-wrapper">
                            <canvas id="incomeChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h3 class="chart-title">Uscite per Categoria</h3>
                        <div class="chart-wrapper">
                            <canvas id="expenseChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="transaction-list">
                    <h3 style="margin: 25px 0 15px 0; color: #333;">Movimenti del Mese</h3>
                    <div id="monthTransactions"></div>
                </div>
            </div>

            <!-- CONTI -->
            <div id="accounts" class="section">
                <h2 style="margin-bottom: 20px; color: #333;">I Miei Conti</h2>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 30px;">
                    <button class="btn" onclick="openModal('accountModal')" style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                        <span style="font-size: 20px;">+</span>
                        <span>Aggiungi Conto</span>
                    </button>
                    <button class="btn btn-success" onclick="openTransferModal()" style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                        <span style="font-size: 20px;">‚ÜîÔ∏è</span>
                        <span>Trasferisci</span>
                    </button>
                </div>

                <div class="account-list" id="accountList"></div>
            </div>

            <!-- CATEGORIE -->
            <div id="categories" class="section">
                <h2 style="margin-bottom: 20px; color: #333;">Gestisci Categorie</h2>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 30px;">
                    <button class="add-category-btn" onclick="openAddCategoryModal()" style="min-height: auto;">
                        <span style="font-size: 24px;">+</span>
                        <span>Aggiungi Categoria</span>
                    </button>
                    <button class="add-category-btn" onclick="exportData()" style="min-height: auto; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <span style="font-size: 24px;">üì§</span>
                        <span>Esporta Dati</span>
                    </button>
                    <button class="add-category-btn" onclick="openImportModal()" style="min-height: auto; background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);">
                        <span style="font-size: 24px;">üì•</span>
                        <span>Importa Dati</span>
                    </button>
                </div>

                <h3 style="margin: 30px 0 15px 0; color: #333;">Categorie Entrate</h3>
                <div class="category-grid" id="incomeCategoryList"></div>

                <h3 style="margin: 30px 0 15px 0; color: #333;">Categorie Uscite</h3>
                <div class="category-grid" id="expenseCategoryList"></div>
            </div>
        </div>
    </div>

    <!-- MODAL TRANSAZIONE -->
    <div id="transactionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Nuova Transazione</h3>
                <button class="close-modal" onclick="closeModal('transactionModal')">√ó</button>
            </div>
            <form id="transactionForm">
                <input type="hidden" id="transactionType">
                <input type="hidden" id="transactionCategory">
                
                <div class="form-group">
                    <label>Importo (‚Ç¨)</label>
                    <div class="calculator-display" id="calculatorDisplay">0</div>
                    <input type="hidden" id="amount" required>
                    
                    <div class="calculator-grid">
                        <button type="button" class="calc-btn" onclick="addToCalculator('7')">7</button>
                        <button type="button" class="calc-btn" onclick="addToCalculator('8')">8</button>
                        <button type="button" class="calc-btn" onclick="addToCalculator('9')">9</button>
                        <button type="button" class="calc-btn calc-btn-operator" onclick="addToCalculator('+')">+</button>
                        
                        <button type="button" class="calc-btn" onclick="addToCalculator('4')">4</button>
                        <button type="button" class="calc-btn" onclick="addToCalculator('5')">5</button>
                        <button type="button" class="calc-btn" onclick="addToCalculator('6')">6</button>
                        <button type="button" class="calc-btn calc-btn-operator" onclick="addToCalculator('-')">‚àí</button>
                        
                        <button type="button" class="calc-btn" onclick="addToCalculator('1')">1</button>
                        <button type="button" class="calc-btn" onclick="addToCalculator('2')">2</button>
                        <button type="button" class="calc-btn" onclick="addToCalculator('3')">3</button>
                        <button type="button" class="calc-btn calc-btn-operator" onclick="addToCalculator('*')">√ó</button>
                        
                        <button type="button" class="calc-btn" onclick="addToCalculator('0')">0</button>
                        <button type="button" class="calc-btn" onclick="addToCalculator('.')">.</button>
                        <button type="button" class="calc-btn calc-btn-clear" onclick="clearCalculator()">C</button>
                        <button type="button" class="calc-btn calc-btn-equals" onclick="calculateResult()">=</button>
                    </div>
                </div>

                <div class="form-group">
                    <label>Conto</label>
                    <select id="account" required>
                        <option value="">Seleziona conto</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Data</label>
                    <input type="date" id="date" required>
                </div>

                <div class="form-group">
                    <label>Note (opzionale)</label>
                    <input type="text" id="notes" placeholder="Descrizione">
                </div>

                <button type="submit" class="btn">Registra</button>
            </form>
        </div>
    </div>

    <!-- MODAL AGGIUNGI CONTO -->
    <div id="accountModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Nuovo Conto</h3>
                <button class="close-modal" onclick="closeModal('accountModal')">√ó</button>
            </div>
            <form id="accountForm">
                <div class="form-group">
                    <label>Nome Conto</label>
                    <input type="text" id="accountName" placeholder="es. Banca, Contanti, PostePay" required>
                </div>
                <div class="form-group">
                    <label>Saldo Iniziale (‚Ç¨)</label>
                    <input type="number" id="initialBalance" step="0.01" placeholder="0.00" required>
                </div>
                <button type="submit" class="btn">Aggiungi Conto</button>
            </form>
        </div>
    </div>

    <!-- MODAL TRASFERIMENTO -->
    <div id="transferModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Trasferisci Denaro</h3>
                <button class="close-modal" onclick="closeModal('transferModal')">√ó</button>
            </div>
            <form id="transferForm">
                <div class="form-group">
                    <label>Da Conto</label>
                    <select id="fromAccount" required>
                        <option value="">Seleziona conto di origine</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>A Conto</label>
                    <select id="toAccount" required>
                        <option value="">Seleziona conto di destinazione</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Importo (‚Ç¨)</label>
                    <input type="number" id="transferAmount" step="0.01" placeholder="0.00" required>
                </div>

                <div class="form-group">
                    <label>Data</label>
                    <input type="date" id="transferDate" required>
                </div>

                <div class="form-group">
                    <label>Note (opzionale)</label>
                    <input type="text" id="transferNotes" placeholder="es. Prelievo bancomat">
                </div>

                <button type="submit" class="btn">Trasferisci</button>
            </form>
        </div>
    </div>

    <!-- MODAL CATEGORIA -->
    <div id="categoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="categoryModalTitle">Nuova Categoria</h3>
                <button class="close-modal" onclick="closeModal('categoryModal')">√ó</button>
            </div>
            <form id="categoryForm">
                <input type="hidden" id="categoryId">
                
                <div class="form-group">
                    <label>Nome Categoria</label>
                    <input type="text" id="categoryName" placeholder="es. Uscite con amici" required>
                </div>

                <div class="form-group">
                    <label>Tipo</label>
                    <select id="categoryType" required>
                        <option value="income">Entrata</option>
                        <option value="expense">Uscita</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Icona</label>
                    <div class="emoji-picker">
                        <div class="emoji-grid" id="emojiGrid">
                            <button type="button" class="emoji-option" onclick="selectEmoji('üí∞')">üí∞</button>
                            <button type="button" class="emoji-option" onclick="selectEmoji('üíº')">üíº</button>
                            <button type="button" class="emoji-option" onclick="selectEmoji('üíª')">üíª</button>
                            <button type="button" class="emoji-option" onclick="selectEmoji('üéÅ')">üéÅ</button>
                            <button type="button" class="emoji-option" onclick="selectEmoji('üíµ')">üíµ</button>
                            <button type="button" class="emoji-option" onclick="selectEmoji('üèÜ')">üèÜ</button>
                            <button type="button" class="emoji-option" onclick="selectEmoji('üè†')">üè†</button>
                            <button type="button" class="emoji-option" onclick="selectEmoji('üõí')">üõí</button>
                            <button type="button" class="emoji-option" onclick="selectEmoji('üçï')">üçï</button>
                            <button type="button" class="emoji-option" onclick="selectEmoji('üçî')">üçî</button>
                            <button type="button" class="emoji-option" onclick="selectEmoji('‚òï')">‚òï</button>
                            <button type="button" class="emoji-option" onclick="selectEmoji('üç∫')">üç∫</button>
                            <button type="button" class="emoji-option" onclick="selectEmoji('üöó')">üöó</button>
                            <button type="button" class="emoji-option" onclick="selectEmoji('üöå')">üöå</button>
                            <button type="button" class="emoji-option" onclick="selectEmoji('‚úàÔ∏è')">‚úàÔ∏è</button>
                            <button type="button" class="emoji-option" onclick="selectEmoji('üèñÔ∏è')">üèñÔ∏è</button>
                            <button type="button" class="emoji-option" onclick="selectEmoji('üí°')">üí°</button>
                            <button type="button" class="emoji-option" onclick="selectEmoji('üì±')">üì±</button>
                            <button type="button" class="emoji-option" onclick="selectEmoji('üíä')">üíä</button>
                            <button type="button" class="emoji-option" onclick="selectEmoji('üè•')">üè•</button>
                            <button type="button" class="emoji-option" onclick="selectEmoji('üõçÔ∏è')">üõçÔ∏è</button>
                            <button type="button" class="emoji-option" onclick="selectEmoji('üëï')">üëï</button>
                            <button type="button" class="emoji-option" onclick="selectEmoji('üëü')">üëü</button>
                            <button type="button" class="emoji-option" onclick="selectEmoji('üìö')">üìö</button>
                            <button type="button" class="emoji-option" onclick="selectEmoji('üéÆ')">üéÆ</button>
                            <button type="button" class="emoji-option" onclick="selectEmoji('üé¨')">üé¨</button>
                            <button type="button" class="emoji-option" onclick="selectEmoji('üéµ')">üéµ</button>
                            <button type="button" class="emoji-option" onclick="selectEmoji('üèãÔ∏è')">üèãÔ∏è</button>
                            <button type="button" class="emoji-option" onclick="selectEmoji('‚öΩ')">‚öΩ</button>
                            <button type="button" class="emoji-option" onclick="selectEmoji('üêï')">üêï</button>
                            <button type="button" class="emoji-option" onclick="selectEmoji('üê±')">üê±</button>
                            <button type="button" class="emoji-option" onclick="selectEmoji('üå≥')">üå≥</button>
                            <button type="button" class="emoji-option" onclick="selectEmoji('üíê')">üíê</button>
                            <button type="button" class="emoji-option" onclick="selectEmoji('üéÇ')">üéÇ</button>
                            <button type="button" class="emoji-option" onclick="selectEmoji('üéâ')">üéâ</button>
                            <button type="button" class="emoji-option" onclick="selectEmoji('‚ù§Ô∏è')">‚ù§Ô∏è</button>
                        </div>
                        <div style="margin-top: 10px; text-align: center;">
                            <span style="font-size: 12px; color: #666;">Selezionata: </span>
                            <input type="text" id="categoryIcon" value="üí∞" readonly style="width: 60px; text-align: center; font-size: 24px; border: 2px solid #667eea; cursor: pointer;" required>
                        </div>
                    </div>
                </div>

                <button type="submit" class="btn">Salva Categoria</button>
            </form>
        </div>
    </div>

    <!-- MODAL IMPORTAZIONE -->
    <div id="importModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Importa Dati da 1Money</h3>
                <button class="close-modal" onclick="closeModal('importModal')">√ó</button>
            </div>
            <div style="padding: 10px 0;">
                <p style="margin-bottom: 15px; color: #666;">
                    Carica il file JSON esportato dal database 1Money.
                </p>
                
                <div class="form-group">
                    <label>Seleziona File JSON</label>
                    <input type="file" id="importFile" accept=".json" style="padding: 10px; border: 2px dashed #667eea; border-radius: 8px; background: #f8f9fa;">
                </div>
                
                <div id="importPreview" style="display: none; margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <h4 style="margin-bottom: 10px; color: #333;">Anteprima:</h4>
                    <div id="importStats"></div>
                </div>
                
                <button class="btn" onclick="executeImport()" id="importBtn" disabled>
                    Importa Dati
                </button>
                
                <p style="margin-top: 15px; font-size: 13px; color: #999;">
                    ‚ö†Ô∏è Attenzione: I dati attuali verranno sovrascritti
                </p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        // ===== STATO DELL'APPLICAZIONE =====
        let currentMonth = new Date();
        let accounts = [];
        let transactions = [];
        let categories = [];
        let incomeChart = null;
        let expenseChart = null;

        // ===== INIZIALIZZAZIONE =====
        function init() {
            loadData();
            
            // Carica il tema salvato
            loadTheme();
            
            // Se non ci sono categorie, crea quelle predefinite
            if (categories.length === 0) {
                createDefaultCategories();
            }
            
            // Se non ci sono conti, crea quello predefinito
            if (accounts.length === 0) {
                accounts = [{ id: Date.now(), name: 'Contanti', initialBalance: 0, isDefault: true }];
                saveData();
            }
            
            document.getElementById('date').valueAsDate = new Date();
            document.getElementById('transferDate').valueAsDate = new Date();
            
            updateAll();
            
            // Event listeners
            document.getElementById('transactionForm').addEventListener('submit', addTransaction);
            document.getElementById('accountForm').addEventListener('submit', addAccount);
            document.getElementById('categoryForm').addEventListener('submit', addCategory);
            document.getElementById('transferForm').addEventListener('submit', executeTransfer);
        }

        // ===== GESTIONE TEMA =====
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            // Aggiorna icona
            const icon = document.getElementById('themeIcon');
            icon.textContent = newTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            
            const icon = document.getElementById('themeIcon');
            if (icon) {
                icon.textContent = savedTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
            }
        }

        function createDefaultCategories() {
            const defaults = [
                { name: 'Stipendio', type: 'income', icon: 'üíº' },
                { name: 'Freelance', type: 'income', icon: 'üíª' },
                { name: 'Regalo', type: 'income', icon: 'üéÅ' },
                { name: 'Affitto', type: 'expense', icon: 'üè†' },
                { name: 'Spesa', type: 'expense', icon: 'üõí' },
                { name: 'Uscite con amici', type: 'expense', icon: 'üçï' },
                { name: 'Trasporti', type: 'expense', icon: 'üöó' },
                { name: 'Bollette', type: 'expense', icon: 'üí°' },
                { name: 'Shopping', type: 'expense', icon: 'üõçÔ∏è' },
                { name: 'Abbonamenti', type: 'expense', icon: 'üì±' }
            ];
            
            let baseId = Date.now();
            defaults.forEach((cat, index) => {
                categories.push({
                    id: baseId + index,
                    name: cat.name,
                    type: cat.type,
                    icon: cat.icon
                });
            });
            
            saveData();
        }

        // ===== GESTIONE DATI =====
        function loadData() {
            accounts = JSON.parse(localStorage.getItem('accounts')) || [];
            transactions = JSON.parse(localStorage.getItem('transactions')) || [];
            categories = JSON.parse(localStorage.getItem('categories')) || [];
        }

        function saveData() {
            localStorage.setItem('accounts', JSON.stringify(accounts));
            localStorage.setItem('transactions', JSON.stringify(transactions));
            localStorage.setItem('categories', JSON.stringify(categories));
        }

        // ===== GESTIONE CATEGORIE =====
        let importData = null;

        function exportData() {
            // Crea l'oggetto con tutti i dati
            const dataToExport = {
                accounts: accounts,
                categories: categories,
                transactions: transactions,
                exportDate: new Date().toISOString(),
                version: '1.0'
            };

            // Converti in JSON
            const jsonString = JSON.stringify(dataToExport, null, 2);
            
            // Crea un blob
            const blob = new Blob([jsonString], { type: 'application/json' });
            
            // Crea un link per il download
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            
            // Nome file con data
            const today = new Date().toISOString().split('T')[0];
            link.download = `finanze_backup_${today}.json`;
            
            // Simula il click
            document.body.appendChild(link);
            link.click();
            
            // Pulizia
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            alert(`‚úÖ Dati esportati con successo!\n\nConti: ${accounts.length}\nCategorie: ${categories.length}\nTransazioni: ${transactions.length}\n\nFile salvato: finanze_backup_${today}.json`);
        }

        function selectEmoji(emoji) {
            document.getElementById('categoryIcon').value = emoji;
            
            // Rimuovi selezione da tutti
            document.querySelectorAll('.emoji-option').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Aggiungi selezione all'emoji cliccata
            event.target.classList.add('selected');
        }

        function openImportModal() {
            openModal('importModal');
            document.getElementById('importFile').value = '';
            document.getElementById('importPreview').style.display = 'none';
            document.getElementById('importBtn').disabled = true;
            importData = null;
        }

        // Gestione file upload
        document.addEventListener('DOMContentLoaded', () => {
            const fileInput = document.getElementById('importFile');
            if (fileInput) {
                fileInput.addEventListener('change', handleFileSelect);
            }
        });

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    importData = JSON.parse(e.target.result);
                    
                    // Mostra anteprima
                    document.getElementById('importPreview').style.display = 'block';
                    document.getElementById('importStats').innerHTML = `
                        <p><strong>Conti:</strong> ${importData.accounts?.length || 0}</p>
                        <p><strong>Categorie:</strong> ${importData.categories?.length || 0}</p>
                        <p><strong>Transazioni:</strong> ${importData.transactions?.length || 0}</p>
                    `;
                    
                    document.getElementById('importBtn').disabled = false;
                } catch (error) {
                    alert('Errore nel leggere il file JSON: ' + error.message);
                    importData = null;
                }
            };
            reader.readAsText(file);
        }

        function executeImport() {
            if (!importData) {
                alert('Nessun dato da importare!');
                return;
            }

            const numTransactions = importData.transactions?.length || 0;
            const numAccounts = importData.accounts?.length || 0;
            const numCategories = importData.categories?.length || 0;

            console.log('Dati da importare:', importData);
            console.log('Accounts:', importData.accounts);
            console.log('Categories:', importData.categories);
            console.log('Transactions:', numTransactions);

            // LIMITE: il localStorage ha un massimo di circa 5-10MB
            // Con 607K transazioni supereremmo il limite
            const MAX_TRANSACTIONS = 50000;
            let transactionsToImport = importData.transactions || [];
            let limitWarning = '';

            if (numTransactions > MAX_TRANSACTIONS) {
                limitWarning = `\n\n‚ö†Ô∏è ATTENZIONE: Il file contiene ${numTransactions.toLocaleString()} transazioni.\nPer limitazioni del browser, verranno importate solo le ultime ${MAX_TRANSACTIONS.toLocaleString()} transazioni.\n\nSe vuoi tutte le transazioni, considera di creare pi√π backup separati per periodo.`;
                
                // Prendi solo le ultime transazioni (ordinate per data)
                transactionsToImport = transactionsToImport
                    .sort((a, b) => new Date(b.date) - new Date(a.date))
                    .slice(0, MAX_TRANSACTIONS);
            }

            if (!confirm(`Confermi l'importazione?\n\n- ${numAccounts} conti\n- ${numCategories} categorie\n- ${transactionsToImport.length.toLocaleString()} transazioni${limitWarning}\n\n‚ö†Ô∏è I dati attuali verranno sostituiti!`)) {
                return;
            }

            try {
                console.log('Inizio importazione...');
                
                // Importa i dati
                accounts = importData.accounts || [];
                categories = importData.categories || [];
                transactions = transactionsToImport;

                console.log('Dati assegnati:', {accounts: accounts.length, categories: categories.length, transactions: transactions.length});

                console.log('Salvataggio in localStorage...');
                saveData();
                console.log('Dati salvati in localStorage');
                
                closeModal('importModal');
                
                console.log('Aggiornamento interfaccia...');
                updateAll();

                console.log('Importazione completata!');

                alert(`‚úÖ Importazione completata con successo!\n\nConti: ${accounts.length}\nCategorie: ${categories.length}\nTransazioni: ${transactions.length.toLocaleString()}`);
            } catch (error) {
                console.error('Errore durante importazione:', error);
                alert(`‚ùå Errore durante l'importazione:\n\n${error.message}\n\nProva a importare meno transazioni o contatta il supporto.`);
            }
        }

        function openAddCategoryModal(type = null) {
            document.getElementById('categoryForm').reset();
            document.getElementById('categoryModalTitle').textContent = 'Nuova Categoria';
            document.getElementById('categoryId').value = '';
            document.getElementById('categoryIcon').value = 'üí∞';
            
            if (type) {
                document.getElementById('categoryType').value = type;
            }
            
            // Reset selezione emoji
            document.querySelectorAll('.emoji-option').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            openModal('categoryModal');
        }

        function openEditCategoryModal(categoryId) {
            const category = categories.find(c => c.id === categoryId);
            if (!category) return;
            
            document.getElementById('categoryModalTitle').textContent = 'Modifica Categoria';
            document.getElementById('categoryId').value = category.id;
            document.getElementById('categoryName').value = category.name;
            document.getElementById('categoryType').value = category.type;
            document.getElementById('categoryIcon').value = category.icon;
            
            // Reset e evidenzia emoji selezionata
            document.querySelectorAll('.emoji-option').forEach(btn => {
                btn.classList.remove('selected');
                if (btn.textContent === category.icon) {
                    btn.classList.add('selected');
                }
            });
            
            openModal('categoryModal');
        }

        function addCategory(e) {
            e.preventDefault();
            
            const categoryId = document.getElementById('categoryId').value;
            const categoryData = {
                name: document.getElementById('categoryName').value,
                type: document.getElementById('categoryType').value,
                icon: document.getElementById('categoryIcon').value
            };
            
            if (categoryId) {
                // Modifica categoria esistente
                const index = categories.findIndex(c => c.id == categoryId);
                if (index !== -1) {
                    categories[index] = { ...categories[index], ...categoryData };
                }
            } else {
                // Nuova categoria
                categories.push({
                    id: Date.now(),
                    ...categoryData
                });
            }
            
            saveData();
            closeModal('categoryModal');
            updateAll();
        }

        function deleteCategory(id) {
            if (confirm('Sei sicuro di voler eliminare questa categoria?')) {
                categories = categories.filter(c => c.id !== id);
                saveData();
                updateAll();
            }
        }

        function getCategoryTotal(categoryId, type) {
            const monthTrans = getMonthTransactions();
            const total = monthTrans
                .filter(t => t.categoryId == categoryId && t.type === type)
                .reduce((sum, t) => sum + t.amount, 0);
            return total;
        }

        // ===== GESTIONE TRANSAZIONI =====
        let calculatorValue = '';

        function addToCalculator(value) {
            calculatorValue += value;
            document.getElementById('calculatorDisplay').textContent = calculatorValue || '0';
        }

        function clearCalculator() {
            calculatorValue = '';
            document.getElementById('calculatorDisplay').textContent = '0';
            document.getElementById('amount').value = '';
        }

        function calculateResult() {
            try {
                // Valuta l'espressione matematica
                const result = eval(calculatorValue.replace('√ó', '*').replace('‚àí', '-'));
                const finalValue = parseFloat(result).toFixed(2);
                
                calculatorValue = finalValue;
                document.getElementById('calculatorDisplay').textContent = finalValue;
                document.getElementById('amount').value = finalValue;
            } catch (error) {
                document.getElementById('calculatorDisplay').textContent = 'Errore';
                setTimeout(() => {
                    clearCalculator();
                }, 1000);
            }
        }

        function openTransactionDrawer(categoryId, categoryName, type) {
            // Reset form PRIMA
            document.getElementById('transactionForm').reset();
            document.getElementById('date').valueAsDate = new Date();
            
            // Reset calcolatrice
            clearCalculator();
            
            // POI imposto i valori (altrimenti il reset li cancella!)
            document.getElementById('transactionType').value = type;
            document.getElementById('transactionCategory').value = categoryId;
            document.getElementById('modalTitle').textContent = categoryName;
            
            // Aggiorna select conti
            updateAccountSelect();
            
            // Pre-seleziona il conto predefinito
            const defaultAccountId = getDefaultAccount();
            if (defaultAccountId) {
                document.getElementById('account').value = defaultAccountId;
            }
            
            openModal('transactionModal');
        }

        function addTransaction(e) {
            e.preventDefault();
            
            // Assicurati che ci sia un importo valido
            const amountValue = document.getElementById('amount').value || calculatorValue;
            
            if (!amountValue || parseFloat(amountValue) <= 0) {
                alert('Inserisci un importo valido!');
                return;
            }
            
            const categoryId = parseInt(document.getElementById('transactionCategory').value);
            const type = document.getElementById('transactionType').value;
            const amount = parseFloat(amountValue);
            
            // Debug temporaneo
            console.log('Salvando transazione:', {
                categoryId: categoryId,
                type: type,
                amount: amount,
                categoriaEsistente: categories.find(c => c.id == categoryId)
            });
            
            const transaction = {
                id: Date.now(),
                type: type,
                categoryId: categoryId,
                amount: amount,
                accountId: parseInt(document.getElementById('account').value),
                date: document.getElementById('date').value,
                notes: document.getElementById('notes').value
            };
            
            transactions.push(transaction);
            saveData();
            
            closeModal('transactionModal');
            
            // Aggiorna tutto inclusi i cassetti
            updateAll();
        }

        function deleteTransaction(id) {
            if (confirm('Sei sicuro di voler eliminare questo movimento?')) {
                transactions = transactions.filter(t => t.id !== id);
                saveData();
                updateAll();
            }
        }

        function getMonthTransactions() {
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            
            return transactions.filter(t => {
                const tDate = new Date(t.date);
                return tDate.getFullYear() === year && tDate.getMonth() === month;
            });
        }

        // ===== GESTIONE CONTI =====
        function addAccount(e) {
            e.preventDefault();
            
            const account = {
                id: Date.now(),
                name: document.getElementById('accountName').value,
                initialBalance: parseFloat(document.getElementById('initialBalance').value),
                isDefault: false
            };
            
            accounts.push(account);
            saveData();
            
            document.getElementById('accountForm').reset();
            closeModal('accountModal');
            updateAll();
        }

        function deleteAccount(id) {
            if (confirm('Sei sicuro di voler eliminare questo conto?')) {
                accounts = accounts.filter(a => a.id !== id);
                saveData();
                updateAll();
            }
        }

        function openTransferModal() {
            document.getElementById('transferForm').reset();
            document.getElementById('transferDate').valueAsDate = new Date();
            
            // Popola i select con i conti
            const fromSelect = document.getElementById('fromAccount');
            const toSelect = document.getElementById('toAccount');
            
            const accountOptions = accounts.map(acc => 
                `<option value="${acc.id}">${acc.name} (${formatCurrency(getAccountBalance(acc.id))})</option>`
            ).join('');
            
            fromSelect.innerHTML = '<option value="">Seleziona conto di origine</option>' + accountOptions;
            toSelect.innerHTML = '<option value="">Seleziona conto di destinazione</option>' + accountOptions;
            
            openModal('transferModal');
        }

        function executeTransfer(e) {
            e.preventDefault();
            
            const fromAccountId = parseInt(document.getElementById('fromAccount').value);
            const toAccountId = parseInt(document.getElementById('toAccount').value);
            const amount = parseFloat(document.getElementById('transferAmount').value);
            const date = document.getElementById('transferDate').value;
            const notes = document.getElementById('transferNotes').value;
            
            // Validazione
            if (fromAccountId === toAccountId) {
                alert('Non puoi trasferire soldi sullo stesso conto!');
                return;
            }
            
            const fromAccount = accounts.find(a => a.id === fromAccountId);
            const toAccount = accounts.find(a => a.id === toAccountId);
            
            if (!fromAccount || !toAccount) {
                alert('Errore: conti non trovati!');
                return;
            }
            
            // Verifica saldo sufficiente
            const fromBalance = getAccountBalance(fromAccountId);
            if (fromBalance < amount) {
                alert(`Saldo insufficiente! Disponibile: ${formatCurrency(fromBalance)}`);
                return;
            }
            
            // Crea categoria "Trasferimento" se non esiste
            let transferCategory = categories.find(c => c.name === 'Trasferimento');
            if (!transferCategory) {
                transferCategory = {
                    id: Date.now(),
                    name: 'Trasferimento',
                    type: 'expense',
                    icon: '‚ÜîÔ∏è'
                };
                categories.push(transferCategory);
            }
            
            // Crea due transazioni (uscita e entrata)
            const timestamp = Date.now();
            
            // Uscita dal conto origine
            transactions.push({
                id: timestamp,
                type: 'expense',
                categoryId: transferCategory.id,
                amount: amount,
                accountId: fromAccountId,
                date: date,
                notes: `Trasferimento a ${toAccount.name}${notes ? ' - ' + notes : ''}`,
                isTransfer: true
            });
            
            // Entrata nel conto destinazione
            transactions.push({
                id: timestamp + 1,
                type: 'income',
                categoryId: transferCategory.id,
                amount: amount,
                accountId: toAccountId,
                date: date,
                notes: `Trasferimento da ${fromAccount.name}${notes ? ' - ' + notes : ''}`,
                isTransfer: true
            });
            
            saveData();
            closeModal('transferModal');
            updateAll();
        }

        function getAccountBalance(accountId) {
            const account = accounts.find(a => a.id === accountId);
            if (!account) return 0;
            
            let balance = account.initialBalance;
            
            transactions.forEach(t => {
                if (t.accountId === accountId) {
                    balance += t.type === 'income' ? t.amount : -t.amount;
                }
            });
            
            return balance;
        }

        // ===== CALCOLI =====
        function calculateTotals() {
            const monthTrans = getMonthTransactions();
            
            const income = monthTrans
                .filter(t => t.type === 'income' && !t.isTransfer)
                .reduce((sum, t) => sum + t.amount, 0);
            
            const expenses = monthTrans
                .filter(t => t.type === 'expense' && !t.isTransfer)
                .reduce((sum, t) => sum + t.amount, 0);
            
            return { income, expenses, balance: income - expenses };
        }

        function getCategoryBreakdown(type) {
            const monthTrans = getMonthTransactions().filter(t => t.type === type && !t.isTransfer);
            const breakdown = {};
            
            monthTrans.forEach(t => {
                const category = categories.find(c => c.id == t.categoryId);
                const categoryName = category ? category.name : 'Altro';
                
                if (!breakdown[categoryName]) {
                    breakdown[categoryName] = 0;
                }
                breakdown[categoryName] += t.amount;
            });
            
            return breakdown;
        }

        // ===== AGGIORNAMENTO UI =====
        function updateAll() {
            updateMonthDisplay();
            updateTotalBalance();
            updateIncomeDrawers();
            updateExpenseDrawers();
            updateBalancePage();
            updateAccountList();
            updateCategoryLists();
            updateAccountSelect();
        }

        function updateTotalBalance() {
            let total = 0;
            accounts.forEach(account => {
                total += getAccountBalance(account.id);
            });
            
            const totalElement = document.querySelector('.total-value');
            if (totalElement) {
                totalElement.textContent = formatCurrency(total);
            }
        }

        function updateMonthDisplay() {
            const monthNames = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno',
                              'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
            document.getElementById('currentMonthDisplay').textContent = 
                `${monthNames[currentMonth.getMonth()]} ${currentMonth.getFullYear()}`;
        }

        function updateIncomeDrawers() {
            const container = document.getElementById('incomeCategories');
            const incomeCategories = categories.filter(c => c.type === 'income');
            
            let html = '';
            
            // Pulsante aggiungi categoria
            html += `
                <div class="add-category-btn" onclick="openAddCategoryModal('income')" style="min-height: 120px;">
                    <span style="font-size: 32px;">+</span>
                    <span style="font-size: 14px;">Aggiungi Categoria</span>
                </div>
            `;
            
            // Categorie esistenti
            if (incomeCategories.length > 0) {
                html += incomeCategories.map(cat => {
                    const total = getCategoryTotal(cat.id, 'income');
                    const safeName = cat.name.replace(/'/g, "\\'");
                    return `
                        <div class="category-drawer income" onclick="openTransactionDrawer(${cat.id}, '${safeName}', 'income')">
                            <button class="delete-category" onclick="event.stopPropagation(); deleteCategory(${cat.id})">√ó</button>
                            <button class="edit-category" onclick="event.stopPropagation(); openEditCategoryModal(${cat.id})">‚úé</button>
                            <div class="category-icon">${cat.icon}</div>
                            <div class="category-name">${cat.name}</div>
                            <div class="category-total">${formatCurrency(total)}</div>
                        </div>
                    `;
                }).join('');
            }
            
            container.innerHTML = html;
        }

        function updateExpenseDrawers() {
            const container = document.getElementById('expenseCategories');
            const expenseCategories = categories.filter(c => c.type === 'expense');
            
            let html = '';
            
            // Pulsante aggiungi categoria
            html += `
                <div class="add-category-btn" onclick="openAddCategoryModal('expense')" style="min-height: 120px;">
                    <span style="font-size: 32px;">+</span>
                    <span style="font-size: 14px;">Aggiungi Categoria</span>
                </div>
            `;
            
            // Categorie esistenti
            if (expenseCategories.length > 0) {
                html += expenseCategories.map(cat => {
                    const total = getCategoryTotal(cat.id, 'expense');
                    const safeName = cat.name.replace(/'/g, "\\'");
                    return `
                        <div class="category-drawer expense" onclick="openTransactionDrawer(${cat.id}, '${safeName}', 'expense')">
                            <button class="delete-category" onclick="event.stopPropagation(); deleteCategory(${cat.id})">√ó</button>
                            <button class="edit-category" onclick="event.stopPropagation(); openEditCategoryModal(${cat.id})">‚úé</button>
                            <div class="category-icon">${cat.icon}</div>
                            <div class="category-name">${cat.name}</div>
                            <div class="category-total">${formatCurrency(total)}</div>
                        </div>
                    `;
                }).join('');
            }
            
            container.innerHTML = html;
        }

        function updateBalancePage() {
            const totals = calculateTotals();
            
            document.getElementById('totalIncome').textContent = formatCurrency(totals.income);
            document.getElementById('totalExpenses').textContent = formatCurrency(totals.expenses);
            document.getElementById('balanceValue').textContent = formatCurrency(totals.balance);
            
            // Aggiorna grafici
            updateCharts();
            
            // Aggiorna lista transazioni
            updateMonthTransactionsList();
        }

        function updateCharts() {
            const incomeBreakdown = getCategoryBreakdown('income');
            const expenseBreakdown = getCategoryBreakdown('expense');
            
            // Grafico entrate
            const incomeCtx = document.getElementById('incomeChart').getContext('2d');
            if (incomeChart) incomeChart.destroy();
            
            if (Object.keys(incomeBreakdown).length === 0) {
                incomeChart = new Chart(incomeCtx, {
                    type: 'pie',
                    data: {
                        labels: ['Nessuna entrata'],
                        datasets: [{
                            data: [1],
                            backgroundColor: ['#e0e0e0']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false }
                        }
                    }
                });
            } else {
                incomeChart = new Chart(incomeCtx, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(incomeBreakdown),
                        datasets: [{
                            data: Object.values(incomeBreakdown),
                            backgroundColor: [
                                '#4caf50', '#8bc34a', '#cddc39', '#ffeb3b', 
                                '#ffc107', '#ff9800', '#ff5722', '#e91e63'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { padding: 15, font: { size: 12 } }
                            }
                        }
                    }
                });
            }
            
            // Grafico uscite
            const expenseCtx = document.getElementById('expenseChart').getContext('2d');
            if (expenseChart) expenseChart.destroy();
            
            if (Object.keys(expenseBreakdown).length === 0) {
                expenseChart = new Chart(expenseCtx, {
                    type: 'pie',
                    data: {
                        labels: ['Nessuna uscita'],
                        datasets: [{
                            data: [1],
                            backgroundColor: ['#e0e0e0']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false }
                        }
                    }
                });
            } else {
                expenseChart = new Chart(expenseCtx, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(expenseBreakdown),
                        datasets: [{
                            data: Object.values(expenseBreakdown),
                            backgroundColor: [
                                '#f44336', '#e91e63', '#9c27b0', '#673ab7',
                                '#3f51b5', '#2196f3', '#03a9f4', '#00bcd4'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { padding: 15, font: { size: 12 } }
                            }
                        }
                    }
                });
            }
        }

        function updateMonthTransactionsList() {
            const container = document.getElementById('monthTransactions');
            const monthTrans = getMonthTransactions();
            
            if (monthTrans.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì≠</div><p>Nessun movimento questo mese</p></div>';
                return;
            }
            
            const sorted = monthTrans.sort((a, b) => new Date(b.date) - new Date(a.date));
            container.innerHTML = sorted.map(t => renderTransaction(t)).join('');
        }

        function updateAccountList() {
            const container = document.getElementById('accountList');
            
            container.innerHTML = accounts.map(account => {
                const balance = getAccountBalance(account.id);
                const isDefault = account.isDefault ? '‚≠ê' : '';
                return `
                    <div class="account-card" style="${account.isDefault ? 'border: 2px solid #667eea;' : ''}">
                        <div class="account-info">
                            <h3>${isDefault} ${account.name}</h3>
                            <div class="account-balance">${formatCurrency(balance)}</div>
                            ${account.isDefault ? '<small style="color: #667eea;">Conto predefinito</small>' : ''}
                        </div>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            ${!account.isDefault ? `
                                <button class="btn-icon" onclick="setDefaultAccount(${account.id})" title="Imposta come predefinito" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                    ‚≠ê
                                </button>
                            ` : ''}
                            <button class="btn-icon btn-danger" onclick="deleteAccount(${account.id})" title="Elimina conto">
                                √ó
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function setDefaultAccount(accountId) {
            // Rimuovi il flag da tutti gli altri conti
            accounts.forEach(acc => acc.isDefault = false);
            
            // Imposta il nuovo conto predefinito
            const account = accounts.find(a => a.id === accountId);
            if (account) {
                account.isDefault = true;
                saveData();
                updateAll();
            }
        }

        function getDefaultAccount() {
            const defaultAcc = accounts.find(a => a.isDefault);
            return defaultAcc ? defaultAcc.id : (accounts[0] ? accounts[0].id : null);
        }

        function updateCategoryLists() {
            const incomeList = document.getElementById('incomeCategoryList');
            const expenseList = document.getElementById('expenseCategoryList');
            
            const incomeCategories = categories.filter(c => c.type === 'income');
            const expenseCategories = categories.filter(c => c.type === 'expense');
            
            incomeList.innerHTML = incomeCategories.map(cat => `
                <div class="category-drawer income">
                    <button class="delete-category" onclick="deleteCategory(${cat.id})">√ó</button>
                    <div class="category-icon">${cat.icon}</div>
                    <div class="category-name">${cat.name}</div>
                </div>
            `).join('');
            
            expenseList.innerHTML = expenseCategories.map(cat => `
                <div class="category-drawer expense">
                    <button class="delete-category" onclick="deleteCategory(${cat.id})">√ó</button>
                    <div class="category-icon">${cat.icon}</div>
                    <div class="category-name">${cat.name}</div>
                </div>
            `).join('');
        }

        function updateAccountSelect() {
            const select = document.getElementById('account');
            select.innerHTML = '<option value="">Seleziona conto</option>' +
                accounts.map(acc => `<option value="${acc.id}">${acc.name}</option>`).join('');
        }

        // ===== HELPER FUNCTIONS =====
        function renderTransaction(transaction) {
            const category = categories.find(c => c.id === transaction.categoryId);
            const account = accounts.find(a => a.id === transaction.accountId);
            const categoryName = category ? category.name : 'Altro';
            const accountName = account ? account.name : 'Sconosciuto';
            const date = new Date(transaction.date).toLocaleDateString('it-IT');
            
            return `
                <div class="transaction-item">
                    <div class="transaction-info">
                        <div class="transaction-category">${category ? category.icon : 'üí∞'} ${categoryName}</div>
                        <div class="transaction-details">
                            ${date} ‚Ä¢ ${accountName}
                            ${transaction.notes ? ` ‚Ä¢ ${transaction.notes}` : ''}
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div class="transaction-amount ${transaction.type}">
                            ${transaction.type === 'income' ? '+' : '-'}${formatCurrency(transaction.amount)}
                        </div>
                        <button class="btn-icon btn-danger" onclick="deleteTransaction(${transaction.id})" title="Elimina movimento">
                            √ó
                        </button>
                    </div>
                </div>
            `;
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('it-IT', {
                style: 'currency',
                currency: 'EUR'
            }).format(amount);
        }

        function changeMonth(direction) {
            currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + direction, 1);
            updateAll();
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Chiudi modal cliccando fuori
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });

        // Avvia l'applicazione
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
